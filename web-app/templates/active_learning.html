<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Active Learning - Utenti Incerti</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="icon" href="{{ url_for('static', filename='img/favicon.ico') }}" type="image/x-icon">
    <link rel="shortcut icon" href="{{ url_for('static', filename='img/favicon.ico') }}" type="image/x-icon">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
<div class="container my-4">

    <div class="text-center mb-4">
        <h1>Active Learning</h1>
        <p class="text-muted">Annota i profili più incerti per migliorare il modello</p>
        <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary">⬅ Torna alla Dashboard</a>
        <a href="{{ url_for('active_learning.retrain_model') }}" class="btn btn-main">🔄 Riaddestra Modello</a>
    </div>

    <!-- Input e bottone per numero utenti da cercare -->
    <div class="input-group mb-3">
        <input type="number" id="ml-limit" class="form-control" placeholder="Numero utenti da cercare" value="5" min="1">
        <button class="btn btn-warning" onclick="scrapeWithML()">🤖 Scraping con Modello ML</button>
    </div>

    <!-- Tabella utenti estratti -->
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Bio</th>
                    <th>Location</th>
                    <th>Followers</th>
                    <th>Following</th>
                    <th>Probabilità</th>
                    <th>Annotazione</th>
                </tr>
            </thead>
            <tbody id="uncertain-tbody">
                <!-- Riempito via JS -->
            </tbody>
        </table>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {

    // --- Funzione globale per caricare utenti incerti ---
    async function loadUncertain() {
        try {
            const resp = await fetch("/active_learning_candidates");
            const data = await resp.json();

            const tbody = document.getElementById("uncertain-tbody");
            tbody.innerHTML = "";

            if (!data.length) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Nessun utente incerto trovato</td></tr>`;
                return;
            }

            data.forEach(user => {
                const row = document.createElement("tr");

                row.innerHTML = `
                    <td><a href="https://github.com/${user.username}" target="_blank">${user.username}</a></td>
                    <td>${user.bio || "-"}</td>
                    <td>${user.location || "-"}</td>
                    <td>${user.followers || 0}</td>
                    <td>${user.following || 0}</td>
                    <td><span class="badge bg-info badge-prob">${user.pred_prob || 0}</span></td>
                    <td class="annotation-btns"></td>
                `;

                const td = row.querySelector(".annotation-btns");

                // Bottoni Promettente / Non valido
                const btnYes = document.createElement("button");
                btnYes.className = "btn btn-sm btn-success";
                btnYes.textContent = "👍 Promettente";
                btnYes.addEventListener("click", () => window.saveAnnotation(user.username, 1));

                const btnNo = document.createElement("button");
                btnNo.className = "btn btn-sm btn-danger";
                btnNo.textContent = "👎 Non valido";
                btnNo.addEventListener("click", () => window.saveAnnotation(user.username, 0));

                td.appendChild(btnYes);
                td.appendChild(btnNo);

                tbody.appendChild(row);
            });
        } catch (err) {
            console.error("Errore caricamento utenti incerti:", err);
            alert("Errore caricamento utenti incerti. Controlla la console.");
        }
    }

    // --- Funzione globale per salvare annotazione ---
    window.saveAnnotation = async function(username, annotation) {
        try {
            const resp = await fetch("/save_annotation", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, annotation })
            });
            const data = await resp.json();
            if (data.success) {
                loadUncertain(); // ricarica la lista
            } else {
                alert("Errore salvataggio: " + (data.error || "Unknown"));
            }
        } catch (err) {
            alert("Errore rete: " + err);
        }
    };

    // --- Funzione globale per avviare scraping ML ---
    window.scrapeWithML = async function() {
        try {
            const limitInput = document.getElementById("ml-limit");
            const limit = limitInput ? parseInt(limitInput.value) || 5 : 5;

            const resp = await fetch(`/scrape_with_ml?limit=${limit}`, { method: "POST" });
            const data = await resp.json();
            if (data.success) {
                alert(`✅ Scraping completato, ${data.inserted} utenti validi trovati`);
                loadUncertain();
            } else {
                alert("Errore: " + (data.error || "Unknown"));
            }
        } catch (err) {
            alert("Errore rete: " + err);
        }
    };

    // Carica subito alla prima apertura
    loadUncertain();
});
</script>
</body>
</html>

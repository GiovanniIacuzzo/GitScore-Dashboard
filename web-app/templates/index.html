<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Utenti GitHub</title>
<link rel="icon" href="{{ url_for('static', filename='img/favicon.ico') }}" type="image/x-icon">
<link rel="shortcut icon" href="{{ url_for('static', filename='img/favicon.ico') }}" type="image/x-icon">

<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

<div class="container my-4">

    <!-- Titolo -->
    <div class="text-center mb-4">
        <h1>Dashboard Utenti GitHub</h1>
    </div>

    <!-- Pulsanti principali -->
    <div class="card shadow-sm p-3 mb-4">
        <div class="d-flex flex-wrap justify-content-center gap-2">
            <a href="{{ url_for('scraper.run_scraper_async') }}" class="btn btn-main">Avvia Scraping</a>
            <a href="{{ url_for('utils.refresh_db') }}" class="btn btn-main">Pulisci Database</a>
            <a href="{{ url_for('email.my_profile_view') }}" class="btn btn-main">Il mio Profilo</a>
            <a href="{{ url_for('user.config') }}" class="btn btn-main">Configurazione</a>
            <a href="{{ url_for('email.manual_email') }}" class="btn btn-main">Email Manuale</a>
            <a href="{{ url_for('active_learning.active_learning') }}" class="btn btn-warning">Active Learning</a>
        </div>
    </div>

    <!-- Filtri -->
    <div class="card shadow-sm p-3 mb-4">
        <div class="section-title">Filtri di ricerca</div>
        <form class="row g-2" method="get" action="{{ url_for('main.index') }}">
            <div class="col-12 col-md-3">
                <select class="form-select" name="city">
                    <option value="">Tutte le città</option>
                    {% for c in [MY_CITY] + NEARBY_CITIES %}
                    <option value="{{ c }}" {% if filters.city == c %}selected{% endif %}>{{ c }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12 col-md-3">
                <select class="form-select" name="keyword">
                    <option value="">Tutte le keyword</option>
                    {% for kw in KEYWORDS_BIO + KEYWORDS_README %}
                    <option value="{{ kw }}" {% if filters.keyword == kw %}selected{% endif %}>{{ kw }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-6 col-md-2">
                <input type="number" class="form-control" name="min_followers" placeholder="Min Followers" value="{{ filters.min_followers }}">
            </div>
            <div class="col-6 col-md-2">
                <select class="form-select" name="sort_by">
                    <option value="score" {% if filters.sort_by == "score" %}selected{% endif %}>Score</option>
                    <option value="followers" {% if filters.sort_by == "followers" %}selected{% endif %}>Followers</option>
                    <option value="following" {% if filters.sort_by == "following" %}selected{% endif %}>Following</option>
                </select>
            </div>
            <div class="col-6 col-md-1 d-grid">
                <button type="submit" class="btn btn-main w-100">Filtra</button>
            </div>
            <div class="col-6 col-md-1 d-grid">
                <button type="button" class="btn btn-outline-success w-100" onclick="exportCSV()">CSV</button>
            </div>
        </form>
    </div>

    <!-- Messaggi Flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Lista utenti a carosello -->
    <div class="card shadow-sm p-3 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="section-title">Lista Utenti</div>
            <div>
                <button class="btn btn-sm btn-outline-primary me-1" onclick="scrollLeft()">&#8592;</button>
                <button class="btn btn-sm btn-outline-primary ms-1" onclick="scrollRight()">&#8594;</button>
            </div>
        </div>
        <div id="users-carousel" class="d-flex overflow-auto"></div>
        <div id="carousel-indicators" class="mt-2 text-center"></div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const carousel = document.getElementById('users-carousel');
const indicators = document.getElementById('carousel-indicators');
const cardWidth = 320;
const limit = 20;
let offset = 0;
let currentIndex = 0;
let totalLoaded = 0;

// Carico un batch di utenti
async function loadUsers() {
    const resp = await fetch(`/get_users_batch?offset=${offset}&limit=${limit}`);
    const users = await resp.json();
    if(users.length === 0) return;
    users.forEach(user => {
        const card = document.createElement("div");
        card.className = "card user-card p-3";
        card.innerHTML = `
            <div>
                <div class="mb-2 text-truncate">
                    <a href="https://github.com/${user.username}" target="_blank"><strong>${user.username}</strong></a>
                </div>
                <div class="mb-1"><strong>Bio:</strong> <span class="bio">${user.bio || "-"}</span></div>
                <div class="mb-1"><strong>Location:</strong> ${user.location || "-"}</div>
                <div class="mb-1"><strong>Followers:</strong> ${user.followers}</div>
                <div class="mb-1"><strong>Following:</strong> ${user.following}</div>
                <div class="mb-1"><strong>Email:</strong> ${user.email_to_notify || "-"}</div>
                <div class="mb-1"><strong>Score:</strong> ${user.score || 0}</div>
            </div>
            <div>
                <input type="text" class="form-control form-control-sm annotation-input" 
                       value="${user.annotation || ''}" data-username="${user.username}">
                <button class="btn btn-sm btn-outline-primary save-annotation-btn mt-1" data-username="${user.username}">Salva</button>
                <div class="d-flex flex-wrap gap-1 mt-2">
                    <a href="/follow/${user.username}" class="btn btn-sm btn-main flex-1">Segui</a>
                    <a href="/send_email/${user.username}" class="btn btn-sm btn-main flex-1">Email</a>
                </div>
            </div>
        `;
        carousel.appendChild(card);
    });
    offset += limit;
    totalLoaded += users.length;
    attachAnnotationEvents();
}

// Scroll e lazy load
function scrollToIndex(index) {
    carousel.scrollTo({ left: index * cardWidth, behavior: 'smooth' });
    currentIndex = index;
}

function scrollLeft() {
    if(currentIndex - 1 >= 0) scrollToIndex(currentIndex - 1);
}

async function scrollRight() {
    if(currentIndex + 1 < totalLoaded) {
        scrollToIndex(currentIndex + 1);
    } else {
        await loadUsers();
        scrollToIndex(currentIndex + 1);
    }
}

// Annotazioni
function attachAnnotationEvents() {
    document.querySelectorAll('.save-annotation-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const username = btn.dataset.username;
            const input = document.querySelector(`.annotation-input[data-username='${username}']`);
            const annotation = input.value;
            fetch("/save_annotation", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, annotation })
            })
            .then(resp => resp.json())
            .then(data => alert(data.success ? "Annotazione salvata ✅" : ("Errore: " + (data.error || "Unknown"))))
            .catch(err => alert("Errore rete: " + err));
        });
    });
}

// Esporta CSV
function exportCSV(){
    let filename = prompt("Nome file CSV:", "utenti_github");
    if(!filename) return;
    fetch("/export_csv")
        .then(resp=>resp.blob())
        .then(blob=>{
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url; a.download = filename + ".csv"; document.body.appendChild(a); a.click(); a.remove();
        }).catch(err=>alert("Errore esportazione: "+err));
}

// Carico il primo batch all’avvio
loadUsers();
</script>

</body>
</html>
